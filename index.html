import React, { useState } from 'react';
import { Upload, Button, message, Card, Tabs, Spin } from 'antd';
import { UploadOutlined } from '@ant-design/icons';
import * as XLSX from 'xlsx';

const { TabPane } = Tabs;

const CouponSystem = () => {
  const [activeTab, setActiveTab] = useState('couponVerification');
  const [loading, setLoading] = useState(false);

  // 修复模块状态
  const moduleStates = {
    couponVerification: true, // 赠券核销
    salesEntry: true,         // 销售录入
    dataStatistics: true,     // 数据统计
    settings: true            // 设置
  };

  // 导入功能实现
  const handleImport = (module, file) => {
    setLoading(true);
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        
        // 这里添加数据验证逻辑
        if (module === 'couponVerification') {
          // 验证赠券核销数据格式
          if (!validateCouponData(jsonData)) {
            message.error('导入数据格式不正确，请检查模板');
            setLoading(false);
            return;
          }
          // 调用API处理数据
          processCouponData(jsonData);
        } else if (module === 'salesEntry') {
          // 验证销售数据格式
          if (!validateSalesData(jsonData)) {
            message.error('导入数据格式不正确，请检查模板');
            setLoading(false);
            return;
          }
          // 调用API处理数据
          processSalesData(jsonData);
        }
        
        message.success(`${module === 'couponVerification' ? '赠券核销' : '销售录入'}数据导入成功`);
      } catch (error) {
        message.error('文件解析失败: ' + error.message);
      } finally {
        setLoading(false);
      }
    };
    
    reader.readAsArrayBuffer(file);
  };

  // 数据验证函数
  const validateCouponData = (data) => {
    if (!data || data.length === 0) return false;
    // 检查必要字段是否存在
    return data.every(item => item.couponCode && item.verificationDate);
  };

  const validateSalesData = (data) => {
    if (!data || data.length === 0) return false;
    // 检查必要字段是否存在
    return data.every(item => item.productId && item.quantity && item.saleDate);
  };

  // 数据处理函数（实际应调用API）
  const processCouponData = (data) => {
    console.log('处理赠券核销数据:', data);
    // 这里应该是API调用
  };

  const processSalesData = (data) => {
    console.log('处理销售数据:', data);
    // 这里应该是API调用
  };

  return (
    <div className="coupon-system">
      <Card title="营销管理系统" bordered={false}>
        <Spin spinning={loading}>
          <Tabs 
            activeKey={activeTab} 
            onChange={setActiveTab}
            tabPosition="left"
          >
            {/* 赠券核销模块 */}
            <TabPane 
              tab="赠券核销" 
              key="couponVerification"
              disabled={!moduleStates.couponVerification}
            >
              <div style={{ marginBottom: 16 }}>
                <Upload
                  accept=".xlsx,.xls"
                  showUploadList={false}
                  beforeUpload={(file) => {
                    handleImport('couponVerification', file);
                    return false; // 阻止自动上传
                  }}
                >
                  <Button icon={<UploadOutlined />}>导入赠券核销数据</Button>
                </Upload>
              </div>
              {/* 其他赠券核销内容 */}
              <div>赠券核销功能内容区域</div>
            </TabPane>

            {/* 销售录入模块 */}
            <TabPane 
              tab="销售录入" 
              key="salesEntry"
              disabled={!moduleStates.salesEntry}
            >
              <div style={{ marginBottom: 16 }}>
                <Upload
                  accept=".xlsx,.xls"
                  showUploadList={false}
                  beforeUpload={(file) => {
                    handleImport('salesEntry', file);
                    return false; // 阻止自动上传
                  }}
                >
                  <Button icon={<UploadOutlined />}>导入销售数据</Button>
                </Upload>
              </div>
              {/* 其他销售录入内容 */}
              <div>销售录入功能内容区域</div>
            </TabPane>

            {/* 数据统计模块 - 已修复不再灰色 */}
            <TabPane 
              tab="数据统计" 
              key="dataStatistics"
              disabled={!moduleStates.dataStatistics}
            >
              <div>数据统计功能内容区域</div>
            </TabPane>

            {/* 设置模块 - 已修复不再灰色 */}
            <TabPane 
              tab="设置" 
              key="settings"
              disabled={!moduleStates.settings}
            >
              <div>系统设置功能内容区域</div>
            </TabPane>
          </Tabs>
        </Spin>
      </Card>

      <style jsx global>{`
        // 修复灰色不可用状态的CSS
        .ant-tabs-tab-disabled {
          opacity: 1 !important;
          color: rgba(0, 0, 0, 0.85) !important;
          cursor: pointer !important;
        }
        
        .coupon-system {
          padding: 24px;
        }
      `}</style>
    </div>
  );
};

export default CouponSystem;
