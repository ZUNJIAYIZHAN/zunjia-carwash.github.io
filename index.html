<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尊驾驿站洗车销售日报表</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        body {
            background: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, #1a3a6c 0%, #2c5aa0 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        .content {
            padding: 25px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 25px;
        }
        .card-title {
            font-size: 18px;
            color: #1a3a6c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-title span {
            font-size: 14px;
            color: #666;
        }
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-item {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .btn-primary {
            background: #2c5aa0;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .delete-btn {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .summary {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a3a6c;
            margin: 5px 0;
        }
        .summary-label {
            color: #666;
            font-size: 14px;
        }
        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 13px;
            border-top: 1px solid #eee;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #2c5aa0;
            color: #2c5aa0;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .voucher-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-valid {
            background: #d4edda;
            color: #155724;
        }
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        .status-used {
            background: #e2e3e5;
            color: #383d41;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        .voucher-card {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #2c5aa0;
        }
        .voucher-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .voucher-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .voucher-detail {
            font-size: 13px;
        }
        .voucher-detail label {
            font-weight: bold;
            color: #666;
            margin-bottom: 2px;
        }
        .voucher-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .action-btn {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
        }
        @media (max-width: 768px) {
            .input-group, .filter-group {
                flex-direction: column;
            }
            .summary {
                grid-template-columns: 1fr;
            }
            .voucher-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>尊驾驿站洗车销售日报表</h1>
            <div class="subtitle">金福能源站 & 尊驾驿站洗车美容会所销售数据追踪</div>
        </header>
        
        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('sales')">销售录入</div>
                <div class="tab" onclick="switchTab('vouchers')">赠券核销</div>
                <div class="tab" onclick="switchTab('statistics')">数据统计</div>
            </div>
            
            <div id="sales-tab" class="tab-content active">
                <!-- 销售录入内容保持不变 -->
            </div>
            
            <div id="vouchers-tab" class="tab-content">
                <div class="card">
                    <div class="card-title">赠券核销管理 <span>促销期: 7月14日-7月31日 (满200元赠洗车券)</span></div>
                    
                    <div class="filter-group">
                        <div class="filter-item">
                            <label>券类型筛选</label>
                            <select id="filterVoucherType" onchange="filterVouchers()">
                                <option value="all">全部类型</option>
                                <option value="标准洗车体验券">标准洗车体验券</option>
                                <option value="洗车包A次数">洗车包A次数</option>
                                <option value="洗车包B次数">洗车包B次数</option>
                                <option value="香薰雾化消毒券">香薰雾化消毒券</option>
                                <option value="汽油优惠券">汽油优惠券</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>状态筛选</label>
                            <select id="filterVoucherStatus" onchange="filterVouchers()">
                                <option value="all">全部状态</option>
                                <option value="valid">未使用</option>
                                <option value="used">已核销</option>
                                <option value="expired">已过期</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>客户手机号</label>
                            <input type="text" id="filterPhone" placeholder="输入客户手机号" onchange="filterVouchers()">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-item">
                            <label>核销日期</label>
                            <input type="date" id="redeemDate">
                        </div>
                        <div class="input-item">
                            <label>操作员</label>
                            <input type="text" id="operator" placeholder="核销操作员姓名">
                        </div>
                        <div class="input-item">
                            <label>核销备注</label>
                            <input type="text" id="redeemRemark" placeholder="输入核销备注信息">
                        </div>
                    </div>
                    
                    <div>
                        <button class="btn btn-primary" onclick="showRedeemModal()">新增核销</button>
                        <button class="btn btn-info" onclick="batchRedeem()">批量核销</button>
                        <button class="btn btn-danger" onclick="clearData('vouchers')">清除核销数据</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">待核销券列表</div>
                    <div id="pendingVouchersList">
                        <!-- 券卡片将通过JS动态添加 -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">今日核销记录 (<span id="todayDate"></span>)</div>
                    <table id="todayRedeemTable">
                        <thead>
                            <tr>
                                <th>核销时间</th>
                                <th>券类型</th>
                                <th>券编号</th>
                                <th>客户手机</th>
                                <th>操作员</th>
                                <th>状态</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 数据将通过JS动态添加 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="statistics-tab" class="tab-content">
                <!-- 数据统计内容保持不变 -->
            </div>
        </div>
        
        <footer>
            <p>尊驾驿站洗车销售日报表系统 | 数据最后更新时间: <span id="updateTime"></span></p>
        </footer>
    </div>

    <!-- 核销模态框 -->
    <div id="redeemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 15px;">核销券详情</h3>
            <div id="voucherDetailContent"></div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-danger" onclick="hideModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmRedeem()">确认核销</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化数据
        let salesData = JSON.parse(localStorage.getItem('zunjiaSalesData')) || [];
        let redeemData = JSON.parse(localStorage.getItem('zunjiaRedeemData')) || [];
        let voucherData = JSON.parse(localStorage.getItem('zunjiaVoucherData')) || [];
        let selectedVoucher = null;
        
        // 生成示例券数据
        function generateSampleVouchers() {
            const today = new Date();
            const sampleVouchers = [];
            
            // 1. 标准洗车体验券 (15天有效期)
            for (let i = 1; i <= 8; i++) {
                const issueDate = new Date('2025-07-' + (14 + Math.floor(i/2)));
                const expireDate = new Date(issueDate);
                expireDate.setDate(issueDate.getDate() + 15);
                
                sampleVouchers.push({
                    id: 'WX-' + Date.now() + i,
                    type: '标准洗车体验券',
                    code: 'VC-' + Math.floor(1000 + Math.random() * 9000),
                    source: i % 2 === 0 ? '金福能源站' : '尊驾驿站',
                    phone: '138' + Math.floor(10000000 + Math.random() * 90000000),
                    issueDate: issueDate.toISOString().split('T')[0],
                    expireDate: expireDate.toISOString().split('T')[0],
                    status: 'valid',
                    quantity: 1,
                    remark: i % 2 === 0 ? '满200元赠送' : '促销活动赠送'
                });
            }
            
            // 2. 洗车包A次数 (180天有效期)
            for (let i = 1; i <= 5; i++) {
                const issueDate = new Date('2025-07-' + (15 + i));
                const expireDate = new Date(issueDate);
                expireDate.setDate(issueDate.getDate() + 180);
                
                sampleVouchers.push({
                    id: 'PKA-' + Date.now() + i,
                    type: '洗车包A次数',
                    code: 'PA-' + Math.floor(1000 + Math.random() * 9000),
                    source: '洗车包A销售',
                    phone: '139' + Math.floor(10000000 + Math.random() * 90000000),
                    issueDate: issueDate.toISOString().split('T')[0],
                    expireDate: expireDate.toISOString().split('T')[0],
                    status: 'valid',
                    quantity: 6,
                    remaining: 6 - Math.floor(i/2),
                    remark: '洗车包A剩余次数'
                });
            }
            
            // 3. 洗车包B次数 (360天有效期)
            for (let i = 1; i <= 3; i++) {
                const issueDate = new Date('2025-07-' + (16 + i));
                const expireDate = new Date(issueDate);
                expireDate.setDate(issueDate.getDate() + 360);
                
                sampleVouchers.push({
                    id: 'PKB-' + Date.now() + i,
                    type: '洗车包B次数',
                    code: 'PB-' + Math.floor(1000 + Math.random() * 9000),
                    source: '洗车包B销售',
                    phone: '137' + Math.floor(10000000 + Math.random() * 90000000),
                    issueDate: issueDate.toISOString().split('T')[0],
                    expireDate: expireDate.toISOString().split('T')[0],
                    status: 'valid',
                    quantity: 12,
                    remaining: 12 - i * 2,
                    remark: '洗车包B剩余次数'
                });
            }
            
            // 4. 汽油优惠券
            for (let i = 1; i <= 4; i++) {
                const issueDate = new Date('2025-07-' + (17 + i));
                const expireDate = new Date(issueDate);
                expireDate.setDate(issueDate.getDate() + 30);
                
                sampleVouchers.push({
                    id: 'OIL-' + Date.now() + i,
                    type: '汽油优惠券',
                    code: 'OIL-' + Math.floor(1000 + Math.random() * 9000),
                    source: '洗车包赠送',
                    phone: '136' + Math.floor(10000000 + Math.random() * 90000000),
                    issueDate: issueDate.toISOString().split('T')[0],
                    expireDate: expireDate.toISOString().split('T')[0],
                    status: 'valid',
                    quantity: 1,
                    discount: '满20升减15元',
                    remark: '与洗车包同时赠送'
                });
            }
            
            return sampleVouchers;
        }
        
        // 初始化数据
        if (voucherData.length === 0) {
            voucherData = generateSampleVouchers();
            localStorage.setItem('zunjiaVoucherData', JSON.stringify(voucherData));
        }
        
        // 更新券状态
        function updateVoucherStatus() {
            const today = new Date().toISOString().split('T')[0];
            voucherData.forEach(voucher => {
                if (voucher.status === 'valid' && voucher.expireDate < today) {
                    voucher.status = 'expired';
                }
            });
            localStorage.setItem('zunjiaVoucherData', JSON.stringify(voucherData));
        }
        
        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'vouchers') {
                updateVoucherTables();
            } else if (tabName === 'statistics') {
                updateStatistics();
            }
        }
        
        // 显示核销模态框
        function showRedeemModal(voucherId = null) {
            if (voucherId) {
                selectedVoucher = voucherData.find(v => v.id === voucherId);
            } else {
                selectedVoucher = null;
            }
            
            const modalContent = document.getElementById('voucherDetailContent');
            
            if (selectedVoucher) {
                // 显示选定券的详情
                modalContent.innerHTML = `
                    <div class="voucher-card">
                        <div class="voucher-header">
                            <span>${selectedVoucher.type}</span>
                            <span class="voucher-status status-${selectedVoucher.status}">
                                ${selectedVoucher.status === 'valid' ? '未使用' : 
                                 selectedVoucher.status === 'used' ? '已核销' : '已过期'}
                            </span>
                        </div>
                        <div class="voucher-details">
                            <div class="voucher-detail">
                                <label>券编号</label>
                                <div>${selectedVoucher.code}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>客户手机</label>
                                <div>${selectedVoucher.phone || '未登记'}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>来源</label>
                                <div>${selectedVoucher.source}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>发放日期</label>
                                <div>${selectedVoucher.issueDate}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>有效期至</label>
                                <div>${selectedVoucher.expireDate}</div>
                            </div>
                            ${selectedVoucher.type.includes('洗车包') ? `
                            <div class="voucher-detail">
                                <label>剩余次数</label>
                                <div>${selectedVoucher.remaining || selectedVoucher.quantity}次</div>
                            </div>
                            ` : ''}
                            ${selectedVoucher.type === '汽油优惠券' ? `
                            <div class="voucher-detail">
                                <label>优惠内容</label>
                                <div>${selectedVoucher.discount}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="voucher-detail">
                            <label>备注</label>
                            <div>${selectedVoucher.remark || '无'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label>核销数量</label>
                        <input type="number" id="modalRedeemQuantity" min="1" max="${selectedVoucher.type.includes('洗车包') ? selectedVoucher.remaining : 1}" value="1" style="width: 100%;">
                    </div>
                `;
            } else {
                // 显示新增核销表单
                modalContent.innerHTML = `
                    <div class="input-group">
                        <div class="input-item">
                            <label>券类型</label>
                            <select id="modalVoucherType">
                                <option value="标准洗车体验券">标准洗车体验券</option>
                                <option value="洗车包A次数">洗车包A次数</option>
                                <option value="洗车包B次数">洗车包B次数</option>
                                <option value="香薰雾化消毒券">香薰雾化消毒券</option>
                                <option value="汽油优惠券">汽油优惠券</option>
                            </select>
                        </div>
                        <div class="input-item">
                            <label>券编号</label>
                            <input type="text" id="modalVoucherCode" placeholder="输入券编号">
                        </div>
                    </div>
                    <div class="input-group">
                        <div class="input-item">
                            <label>客户手机号</label>
                            <input type="text" id="modalVoucherPhone" placeholder="输入客户手机号">
                        </div>
                        <div class="input-item">
                            <label>核销数量</label>
                            <input type="number" id="modalRedeemQuantity" min="1" value="1">
                        </div>
                    </div>
                    <div class="input-item">
                        <label>核销备注</label>
                        <textarea id="modalVoucherRemark" rows="3" placeholder="输入核销备注信息"></textarea>
                    </div>
                `;
            }
            
            document.getElementById('redeemModal').style.display = 'flex';
        }
        
        // 隐藏模态框
        function hideModal() {
            document.getElementById('redeemModal').style.display = 'none';
        }
        
        // 确认核销
        function confirmRedeem() {
            const date = document.getElementById('redeemDate').value || new Date().toISOString().split('T')[0];
            const operator = document.getElementById('operator').value || '系统';
            const remark = document.getElementById('redeemRemark').value;
            
            if (selectedVoucher) {
                // 核销选定的券
                const quantity = parseInt(document.getElementById('modalRedeemQuantity').value) || 1;
                
                if (selectedVoucher.type.includes('洗车包') && quantity > selectedVoucher.remaining) {
                    alert('核销数量不能超过剩余次数！');
                    return;
                }
                
                // 更新券状态
                if (selectedVoucher.type.includes('洗车包')) {
                    selectedVoucher.remaining -= quantity;
                    if (selectedVoucher.remaining === 0) {
                        selectedVoucher.status = 'used';
                    }
                } else {
                    selectedVoucher.status = 'used';
                }
                
                // 添加核销记录
                redeemData.push({
                    id: selectedVoucher.id,
                    date,
                    voucherType: selectedVoucher.type,
                    code: selectedVoucher.code,
                    quantity,
                    phone: selectedVoucher.phone,
                    operator,
                    status: 'used',
                    expireDate: selectedVoucher.expireDate,
                    remark: remark || selectedVoucher.remark
                });
            } else {
                // 新增核销记录
                const voucherType = document.getElementById('modalVoucherType').value;
                const code = document.getElementById('modalVoucherCode').value;
                const phone = document.getElementById('modalVoucherPhone').value;
                const quantity = parseInt(document.getElementById('modalRedeemQuantity').value) || 1;
                const voucherRemark = document.getElementById('modalVoucherRemark').value;
                
                if (!voucherType || !code) {
                    alert('请填写券类型和券编号！');
                    return;
                }
                
                // 查找对应的券
                const voucher = voucherData.find(v => 
                    v.type === voucherType && 
                    v.code === code && 
                    (v.phone === phone || !phone)
                );
                
                if (voucher) {
                    // 更新券状态
                    if (voucher.type.includes('洗车包')) {
                        if (voucher.remaining && voucher.remaining >= quantity) {
                            voucher.remaining -= quantity;
                            if (voucher.remaining === 0) {
                                voucher.status = 'used';
                            }
                        } else {
                            alert('剩余次数不足！');
                            return;
                        }
                    } else {
                        voucher.status = 'used';
                    }
                    
                    // 添加核销记录
                    redeemData.push({
                        id: voucher.id,
                        date,
                        voucherType,
                        code,
                        quantity,
                        phone: phone || voucher.phone,
                        operator,
                        status: 'used',
                        expireDate: voucher.expireDate,
                        remark: voucherRemark || voucher.remark
                    });
                } else {
                    // 添加无券信息的核销记录
                    redeemData.push({
                        id: 'MANUAL-' + Date.now(),
                        date,
                        voucherType,
                        code,
                        quantity,
                        phone,
                        operator,
                        status: 'used',
                        remark: voucherRemark || '手动核销'
                    });
                }
            }
            
            localStorage.setItem('zunjiaRedeemData', JSON.stringify(redeemData));
            localStorage.setItem('zunjiaVoucherData', JSON.stringify(voucherData));
            
            updateVoucherTables();
            hideModal();
            alert('核销记录添加成功！');
        }
        
        // 批量核销
        function batchRedeem() {
            const selectedVouchers = Array.from(document.querySelectorAll('.voucher-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedVouchers.length === 0) {
                alert('请先选择要核销的券！');
                return;
            }
            
            const date = document.getElementById('redeemDate').value || new Date().toISOString().split('T')[0];
            const operator = document.getElementById('operator').value || '批量操作';
            const remark = document.getElementById('redeemRemark').value || '批量核销';
            
            selectedVouchers.forEach(voucherId => {
                const voucher = voucherData.find(v => v.id === voucherId);
                if (voucher && voucher.status === 'valid') {
                    // 更新券状态
                    if (voucher.type.includes('洗车包')) {
                        voucher.remaining = (voucher.remaining || voucher.quantity) - 1;
                        if (voucher.remaining === 0) {
                            voucher.status = 'used';
                        }
                    } else {
                        voucher.status = 'used';
                    }
                    
                    // 添加核销记录
                    redeemData.push({
                        id: voucher.id,
                        date,
                        voucherType: voucher.type,
                        code: voucher.code,
                        quantity: 1,
                        phone: voucher.phone,
                        operator,
                        status: 'used',
                        expireDate: voucher.expireDate,
                        remark: remark
                    });
                }
            });
            
            localStorage.setItem('zunjiaRedeemData', JSON.stringify(redeemData));
            localStorage.setItem('zunjiaVoucherData', JSON.stringify(voucherData));
            
            updateVoucherTables();
            alert(`成功核销 ${selectedVouchers.length} 张券！`);
        }
        
        // 更新券表格
        function updateVoucherTables() {
            updateVoucherStatus();
            
            const pendingList = document.getElementById('pendingVouchersList');
            pendingList.innerHTML = '';
            
            const todayTableBody = document.querySelector('#todayRedeemTable tbody');
            todayTableBody.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayDate').textContent = today;
            
            const typeFilter = document.getElementById('filterVoucherType').value;
            const statusFilter = document.getElementById('filterVoucherStatus').value;
            const phoneFilter = document.getElementById('filterPhone').value;
            
            // 更新待核销券列表
            voucherData
                .filter(voucher => {
                    const matchType = typeFilter === 'all' || voucher.type.includes(typeFilter);
                    const matchStatus = statusFilter === 'all' || voucher.status === statusFilter;
                    const matchPhone = !phoneFilter || (voucher.phone && voucher.phone.includes(phoneFilter));
                    return matchType && matchStatus && matchPhone;
                })
                .forEach(voucher => {
                    const statusClass = voucher.status === 'valid' ? 'status-valid' : 
                                      voucher.status === 'used' ? 'status-used' : 'status-expired';
                    const statusText = voucher.status === 'valid' ? '未使用' : 
                                     voucher.status === 'used' ? '已核销' : '已过期';
                    
                    const voucherCard = document.createElement('div');
                    voucherCard.className = 'voucher-card';
                    voucherCard.innerHTML = `
                        <div class="voucher-header">
                            <span>${voucher.type}</span>
                            <span class="voucher-status ${statusClass}">${statusText}</span>
                        </div>
                        <div class="voucher-details">
                            <div class="voucher-detail">
                                <label>券编号</label>
                                <div>${voucher.code}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>客户手机</label>
                                <div>${voucher.phone || '未登记'}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>来源</label>
                                <div>${voucher.source}</div>
                            </div>
                            <div class="voucher-detail">
                                <label>有效期至</div>
                                <div>${voucher.expireDate}</div>
                            </div>
                            ${voucher.type.includes('洗车包') ? `
                            <div class="voucher-detail">
                                <label>剩余次数</label>
                                <div>${voucher.remaining || voucher.quantity}次</div>
                            </div>
                            ` : ''}
                            ${voucher.type === '汽油优惠券' ? `
                            <div class="voucher-detail">
                                <label>优惠内容</label>
                                <div>${voucher.discount}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="voucher-detail">
                            <label>备注</label>
                            <div>${voucher.remark || '无'}</div>
                        </div>
                        <div class="voucher-actions">
                            ${voucher.status === 'valid' ? `
                            <input type="checkbox" class="voucher-checkbox" value="${voucher.id}" style="margin-right: 5px;">
                            <button class="btn btn-primary action-btn" onclick="showRedeemModal('${voucher.id}')">核销</button>
                            ` : ''}
                        </div>
                    `;
                    
                    pendingList.appendChild(voucherCard);
                });
            
            // 更新今日核销记录表
            redeemData
                .filter(record => record.date === today)
                .forEach(record => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.voucherType}</td>
                        <td>${record.code}</td>
                        <td>${record.phone || '-'}</td>
                        <td>${record.operator || '-'}</td>
                        <td><span class="voucher-status status-${record.status}">已核销</span></td>
                        <td>${record.remark || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteVoucherRecord('${record.id}')">×</button></td>
                    `;
                    
                    todayTableBody.appendChild(row);
                });
        }
        
        // 删除核销记录
        function deleteVoucherRecord(recordId) {
            if (confirm('确定删除这条核销记录吗？')) {
                const recordIndex = redeemData.findIndex(r => r.id === recordId);
                if (recordIndex !== -1) {
                    const record = redeemData[recordIndex];
                    
                    // 如果是洗车包次卡，恢复剩余次数
                    if (record.voucherType.includes('洗车包')) {
                        const voucher = voucherData.find(v => v.id === record.id);
                        if (voucher) {
                            voucher.remaining = (voucher.remaining || 0) + record.quantity;
                            if (voucher.status === 'used' && voucher.remaining > 0) {
                                voucher.status = 'valid';
                            }
                        }
                    } else {
                        // 其他券恢复为未使用状态
                        const voucher = voucherData.find(v => v.id === record.id);
                        if (voucher) {
                            voucher.status = 'valid';
                        }
                    }
                    
                    redeemData.splice(recordIndex, 1);
                    localStorage.setItem('zunjiaRedeemData', JSON.stringify(redeemData));
                    localStorage.setItem('zunjiaVoucherData', JSON.stringify(voucherData));
                    
                    updateVoucherTables();
                }
            }
        }
        
        // 初始化日期
        function initDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('redeemDate').value = today;
            document.getElementById('todayDate').textContent = today;
            document.getElementById('updateTime').textContent = new Date().toLocaleString();
        }
        
        // 初始化
        initDate();
        updateVoucherTables();
    </script>
</body>
</html>
